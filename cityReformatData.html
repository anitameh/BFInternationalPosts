<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Reformat Data</title>
    </head>
    <body>

    	<!-- // <script src="scripts/underscore.js" type="text/javascript"></script> -->
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script src="http://d3js.org/queue.v1.min.js"></script>
        <script src="libs/FileSaver.js"></script>


        <style type="text/css">

            .background {
            	fill: none;
            	pointer-events: all;
            }

        </style>

        <script type="text/javascript">

        // initialize vars
        var languages = ["en", "es", "fr", "pt", "de"];

        // read in data
        d3.csv("new-data/all-city-language-data.csv", function(error, data) {

            var output = [];
            var weeks = []; // depending on the data, this could be a misnomer. Inputted data could also be daily.

            data.forEach(function(d, count) {

                // get keys and values
                var keys = d3.keys(d);
                var values = d3.values(d);

                // if this is the first row, initialize and create weekly dictionaries
                if (count == 0) {
                    // get weeks
                    keys.forEach(function(dd) {
                        if ( !isNaN(parseInt(dd)) ) {
                            weeks.push(parseInt(dd));
                        }
                    });

                    // iterate through weeks
                    for (var i=0; i<weeks.length; i++) {
                        
                        var weeklyData = {}; // create weekly dictionary
                        weeklyData["week"] = weeks[i]; // store week #

                        // other info
                        var info = [];
                        for (var j=0; j<languages.length; j++) {

                            // language
                            var langDict = {};
                            langDict["language"] = languages[j];
                            
                            // pageviews
                            var pageviews = [];
                            var langColName = "Language" + String(weeks[i]);

                            if (d[langColName] == languages[j]) {
                                var inner = {};
                                inner["city"] = d.City;
                                inner["pv"] = parseInt( d[weeks[i]] );
                                inner["LAT"] = parseFloat( d.Latitude );
                                inner["LON"] = parseFloat( d.Longitude );
                                pageviews.push(inner);
                            }
                            langDict["pageviews"] = pageviews;
                            info.push(langDict);
                        }
                        weeklyData["info"] = info;
                        output.push(weeklyData);
                    }
                }
                else {
                    // for all other rows, just push data to correct place
                    output.forEach(function(dd) {
                        for (var i=0; i<weeks.length; i++) {
                            if (dd.week == keys[i]) {
                                var langColName = "Language" + String(weeks[i]);
                                var indexOfLang = languages.indexOf( d[langColName] );
                                var thisLangDict = dd.info[indexOfLang];

                                // push info
                                var inner = {};
                                inner["city"] = d.City;
                                inner["pv"] = parseInt( d[weeks[i]] );
                                inner["LAT"] = parseInt( d.Latitude );
                                inner["LON"] = parseInt( d.Longitude );
                                thisLangDict.pageviews.push(inner);
                                

                            }
                        }
                    });
                }
            });
            console.log("output:");
            console.log(output);

            // output as json
            saveToFile(output, "all-city-language-data.js");
            

        });
        
        // function that saves to JSON
        var saveToFile = function(object, filename) {
            var blob, blobText;
            blobText = [JSON.stringify(object)];
            blob = new Blob(blobText, {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, filename);
        }

        </script>

    </body>
</html>